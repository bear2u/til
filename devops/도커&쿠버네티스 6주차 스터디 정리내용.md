## ë„ì»¤&ì¿ ë²„ë„¤í‹°ìŠ¤ 6ì£¼ì°¨ ìŠ¤í„°ë”” ì •ë¦¬ë‚´ìš©

> ë¶€ì‚°ì—ì„œ ë§¤ì£¼ ì§„í–‰ë˜ëŠ” ìŠ¤í„°ë””ì…ë‹ˆë‹¤. 
>
> ë¶€ì‚°ì—ì„œ ë‹¤ë¥¸ ìŠ¤í„°ë”” ë‚´ìš©ì„ ë³´ì‹¤ë ¤ë©´ [ì¹´í˜](https://cafe.naver.com/busandev) ì—ì„œ ë³´ì‹¤ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>
> <https://www.udemy.com/docker-and-kubernetes-the-complete-guide> ì„ ê³µë¶€í•˜ê³  ìˆìŠµë‹ˆë‹¤
>
> ì¶œì²˜: 
>
> http://javaexpert.tistory.com/990?category=719756

1ì£¼ì°¨ ìŠ¤í„°ë””

- [Dockerfileì„ ì´ìš©í•œ ì„œë²„ ë°°í¬](http://javaexpert.tistory.com/967?category=719756)

2ì£¼ì°¨ ìŠ¤í„°ë””

- [Docker-compose ì…ë¬¸](http://javaexpert.tistory.com/975?category=719756)

3ì£¼ì°¨ ìŠ¤í„°ë””

- [githubë¥¼ í†µí•´ aws ec2ë¡œ ìë™ ë°°í¬ #1](http://javaexpert.tistory.com/984?category=719756)

4ì£¼ì°¨ ìŠ¤í„°ë””

- [githubë¥¼ í†µí•´ aws ec2ë¡œ ìë™ ë°°í¬ #2](http://javaexpert.tistory.com/986)

5ì£¼ì°¨ ìŠ¤í„°ë””

- [ë³µì¡í•œ í˜•íƒœì˜ ì„œë¹„ìŠ¤ë¥¼ ë„ì»¤ë¡œ ë°°í¬í•˜ê¸°](http://javaexpert.tistory.com/990)

## ìŠ¤í„°ë”” ë‚´ìš©

ì´ë²ˆ 6ì£¼ì°¨ì—ëŠ” ì´ì „ ì£¼ì°¨ì—ì„œ ê³µë¶€í•œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ `Client Production` ì„ `Docker Hub` ë¡œ `Travis`ë¥¼ í†µí•´ì„œ ìë™ ë°°í¬í•˜ëŠ” ê±¸ ë°°ìš¸ ì˜ˆì •ì´ë‹¤. 

ê·¸ë¦¬ê³  `Production` ì„ í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œë„ ê³µë¶€í•˜ë„ë¡ í•œë‹¤. 

ì´ì „ì— ë°°ìš´ ë‚´ìš©(`Single`) ê³¼ ì´ë²ˆ ì£¼ì°¨ ë¶€í„° ë°°ìš¸ ë‚´ìš©ì— ëŒ€í•œ `Flow` ë¥¼ ì•Œì•„ë³´ë„ë¡ í•˜ì. 

### Single Container Flow

- Github ì— í‘¸ì‹œ
- `Travis` ì— ìë™ìœ¼ë¡œ ë ˆí¬ë¥¼ ì›¹í›…ìœ¼ë¡œ ê°€ì ¸ì˜¨ë‹¤. 
- `Travis`ì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ì½”ë“œë“¤ì„ í…ŒìŠ¤íŒ… í•œë‹¤. 
- `AWE EB(ElasticBean)` ì— `Travis`ëŠ” ì½”ë“œë¥¼ í‘¸ì‹œí•œë‹¤. 
- `EB`ëŠ” ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ê·¸ê±¸ ë°°í¬í•œë‹¤. 

![1541856986612](1541856986612.png)

### Multi Container Flow

- `Github` ì— í‘¸ì‹œ
- `Travis`ì— ìë™ìœ¼ë¡œ ë ˆí¬ë¥¼ ì›¹í›…ìœ¼ë¡œ ê°€ì ¸ì˜¨ë‹¤. 
- `Travis` ëŠ” ì´ë¯¸ì§€ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê³  ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸í•œë‹¤. 
- **Travis ëŠ” Production ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•œë‹¤. **
- `Travis `ëŠ” ë„ì»¤í—ˆë¸Œì— `Prod.` ì´ë¯¸ì§€ë“¤ì„ í‘¸ì‹œí•œë‹¤. 
  - `Docker Hub ID,PWD` ëŠ” ë”°ë¡œ ì…‹íŒ…ì—ì„œ ì €ì¥í•œë‹¤. 
- `Travis` ëŠ” `AWS EB` ì— í”„ë¡œì íŠ¸ë¥¼ í‘¸ì‹œí•œë‹¤. 
- `EB`ëŠ” ë„ì»¤í—ˆë¸Œë¡œ ë¶€í„° ì´ë¯¸ì§€ë“¤ì„ ê°€ì ¸ì™€ì„œ ë°°í¬í•œë‹¤. 

![1541857220104](1541857220104.png)

## ì‚¬ì „ ì¤€ë¹„

ì ê·¸ëŸ¼ ì‹œì‘ì„ í•´ë³´ì. 

ìš°ì„  ì†ŒìŠ¤ë¥¼ ì´ì „êº¼ ë‹¤ìŒìœ¼ë¡œ ì§„í–‰í• í…ë° `Github checkout` ìœ¼ë¡œ ê°™ì´ ì‹œì‘ì„ í•  ìˆ˜ ìˆë‹¤. 

```
> git clone https://github.com/bear2u/docker-study2.git
...
> git checkout 64b470215f24a1450cd7d70d72f79700f0781542
....

```

### Dockerfile

> `worker / Dockerfile`

`Dockerfile.dev` íŒŒì¼ ë‚´ìš©ê³¼ ê°™ìœ¼ë©° ë§ˆì§€ë§‰ì— ì»¤ë§¨ë“œ ë¼ì¸ë§Œ `dev` -> `start` ë¡œ ë³€ê²½í•´ì¤€ë‹¤. 

```
FROM node:alpine
WORKDIR "/app"
COPY ./package.json ./
RUN npm install
COPY . .
CMD ["npm", "run", "start"]
```

> `server / Dockerfile`

```
FROM node:alpine
WORKDIR "/app"
COPY ./package.json ./
RUN npm install
COPY . .
CMD ["npm", "run", "start"]
```

> `nginx / Dockerfile`

```
FROM nginx
COPY ./default.conf /etc/ngnix/conf.d/default.conf
```

### Client with another nginx

`client` ì€ ì¢€ ë³µì¡í•˜ë‹¤. 

`ì‹±ê¸€ ì½˜í…Œì´ë„ˆ`ë¥¼ ë§Œë“¤ë•Œ `nginx` ì™€ `react build`ë¥¼ í†µí•´ì„œ ì„œë²„ë¥¼ êµ¬ì„±í–ˆì—ˆë‹¤. 

![1541858471574](1541858471574.png)

í•˜ì§€ë§Œ ë©€í‹° ì½˜í…Œì´ë„ˆë¥¼ êµ¬ì„±ì‹œ ì™¸ë¶€ì—ë„ `nginx` ë¥¼ ë‘ê³  ë‚´ë¶€ì—ë„ `nginx` ë¥¼ ì„¸íŒ…í•´ì•¼ í•˜ëŠ” ê±¸ ëª…ì‹¬í•˜ì. 

![1541858595682](1541858595682.png)

ê·¸ëŸ¼ ë©€í‹° ì½˜í…Œì´ë„ˆ êµ¬ì„±ì‹œ ì–´ë–»ê²Œ í•˜ëŠ”ì§€ ì•Œì•„ë³´ì. 

### Client ë‚´ë¶€ ngnix êµ¬ì„± 

> `client / nginx`/ `default.conf`

3000 í¬íŠ¸ë¡œ ë“¤ì–´ì˜¤ë„ë¡ í—ˆìš©í•˜ë©° `index` íŒŒì¼ì„ ë©”ì¸ìœ¼ë¡œ í•œë‹¤.

```
server {
    listen 3000;

    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }
}
```

> `client`/`Dockerfile`

- `builder` ì´ë¯¸ì§€ì— `build` ëœ `Prod` íŒŒì¼ë“¤ì„ ë„£ê³ 
- `nginx` ì„¤ì •ì„ ë³µì‚¬ë¥¼ í•˜ê³ 
- `nginx` ì— ì´ì „ `builder` ë‚´ `/app/build` í´ë”ì— ìˆëŠ” `Prod` íŒŒì¼ë“¤ì„ `html` ë¡œ ë³µì‚¬ë¥¼ í•´ì¤€ë‹¤. 

```
FROM node:alpine as builder
WORKDIR '/app'
COPY ./package.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx
EXPOSE 3000
COPY ./nginx/default.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/build /user/share/nginx/html
```

### Client test ìˆ˜ì •

í˜„ì¬ë¡œì¬ `Client Test`  ì§„í–‰ì‹œ ì¶©ëŒì´ ë°œìƒë  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤. ë‹¹ì¥ì€ ë¹„í™œì„±í™”ë¥¼ í•˜ê³  ì§„í–‰í•˜ë„ë¡ í•˜ì. 

> `client / src/ App.test.js`

```
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';

it('renders without crashing', () => {});
```

ì´ì œ ì¤€ë¹„ê°€ ë‹¤ ë˜ì—ˆë‹¤. Travis ë¥¼ ì—°ê²°í•´ì„œ ë°°í¬ë¥¼ í•´ë³´ì. 

## Travis + Github ì—°ë™

ë§Œì•½ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ì´ë©´ `Github`ì— ì €ì¥ì†Œë¥¼ ë§Œë“¤ì–´ì„œ í‘¸ì‹œí•˜ê³ `Travis` ì—ì„œ í™œì„±í™”ë¥¼ í•´ì£¼ë„ë¡ í•˜ì. 

- `Github` ì— í‘¸ì‹œ

- `Travis` ì—ì„œ ì—°ë™

  - ë§Œì•½ ëª©ë¡ì— ì•ˆë‚˜ì˜¨ë‹¤ë©´ ì™¼ìª½ ìƒë‹¨ì— `Sync Account`ë¥¼ í´ë¦­í•´ì„œ ë™ê¸°í™”ë¥¼ í•˜ì. 

    ![1541860215515](1541860215515.png)



![1541860438426](1541860438426.png)

## Travis ì„¤ì •

![1541860575095](1541860575095.png)

> `.travis.yml`
>
> ì£¼ì˜ì ì€ `travis` ì„¤ì •ì‹œ íƒœê·¸ë¥¼ ê¼­ ë„ì»¤ í—ˆë¸Œ ì•„ì´ë””ë¥¼ íƒœê·¸ëª…ìœ¼ë¡œ ì§€ì •í•´ì¤˜ì•¼ í•œë‹¤. 

```
sudo: required
services:
  - docker

before_install:
  - docker build -t bear2u/react-test -f ./client/Dockerfile.dev ./client

script:
  - docker run bear2u/react-test npm test -- --coverage

after_success:
  - docker build -t bear2u/multi-client ./client
  - docker build -t bear2u/multi-nginx ./nginx
  - docker build -t bear2u/multi-server ./server
  - docker build -t bear2u/multi-worker ./worker
  # Log in to the docker CLI
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin
  # Take those images and push them to docker hub
  - docker push bear2u/multi-client
  - docker push bear2u/multi-nginx
  - docker push bear2u/multi-server
  - docker push bear2u/multi-worker

```

`Beanstalk` ì— ì˜¬ë¦¬ëŠ” ê³¼ì •ì„ ì œì™¸í•œ `docker hub`ì— ì˜¬ë¦¬ëŠ” ê²ƒê¹Œì§€ ì§„í–‰ë˜ì—ˆë‹¤. 

ë„ì»¤ í—ˆë¸Œ ê´€ë ¨í•´ì„œ `id, password` ëŠ” ì…‹íŒ…ì„ í†µí•´ì„œ í•´ì¤€ë‹¤. 

> `Settings`



![1541861411570](1541861411570.png)

ê·¸ëŸ¼ `Github`ì— í‘¸ì‹œë¥¼ í•´ë³¸ë‹¤. 

`Travis` ê°€ ì •ìƒì ìœ¼ë¡œ ì—°ë™ë˜ì–´ì„œ `hub` ì— í‘¸ì‹œê°€ ë˜ëŠ” ê±¸ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. 

```
.... 


Time:        1.19s
Ran all test suites.
--------------------------|----------|----------|----------|----------|-------------------|
File                      |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line #s |
--------------------------|----------|----------|----------|----------|-------------------|
All files                 |        0 |        0 |        0 |        0 |                   |
 App.js                   |        0 |      100 |        0 |        0 |                10 |
 Fib.js                   |        0 |      100 |        0 |        0 |... 44,45,52,56,62 |
 OtherPage.js             |        0 |      100 |        0 |        0 |                 5 |
 index.js                 |        0 |        0 |        0 |        0 |     1,2,3,4,5,7,8 |
 registerServiceWorker.js |        0 |        0 |        0 |        0 |... 36,137,138,139 |
--------------------------|----------|----------|----------|----------|-------------------|
travis_time:end:2e40ccb6:start=1541861556459182738,finish=1541861559398870991,duration=29396882

......
......


ac7ed8526610: Pushed
5761fba18cc8: Pushed
e9aaefdfed5d: Pushed
latest: digest: sha256:2eadc96e313836b05b807d46c2692c2818856c11aa1aa15dde69edd2103a5315 size: 1782
travis_time:end:0578baae:start=1541861604426303298,finish=1541861609935082744,duration=5508779446
[0Ktravis_fold:end:after_success.9
[0K
Done. Your build exited with 0.
```

![1541861811733](1541861811733.png)



ì´ë ‡ê²Œ ë„ì»¤ í—ˆë¸Œì— ì •ìƒì ìœ¼ë¡œ ì˜¬ë¼ê°„ ê±¸ ë³¼ìˆ˜ ìˆë‹¤. 

ì—¬ê¸°ê¹Œì§€ ì†ŒìŠ¤ëŠ” `Github` ì—ì„œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤. 

ë‹¤ìŒ ì‹œê°„ì—ëŠ” aws ì˜ `beanstalk` ìœ¼ë¡œ ì˜¬ë ¤ì„œ `docker hub`ë¥¼ í†µí•´ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™€ì„œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ê³µë¶€í•  ì˜ˆì •ì´ë‹¤. 

ì´ìƒìœ¼ë¡œ ë„ì»¤ & ì¿ ë²„ë„¤í‹°ìŠ¤ 6ì£¼ì°¨ ìŠ¤í„°ë”” ì •ë¦¬ ë‚´ìš©ì´ë‹¤. 

ì°¸ì„í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. 